<!DOCTYPE html>
<html>
<head>
    <title>Pack Consistency Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .card { display: inline-block; margin: 5px; padding: 5px; background: #f0f0f0; }
        .picked { background: #90ee90; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Pack Consistency Debug Test</h1>
    
    <div class="section">
        <h2>Current State</h2>
        <div id="current-state"></div>
    </div>
    
    <div class="section">
        <h2>Actions</h2>
        <button onclick="pickCard()">Pick First Card</button>
        <button onclick="navigateBack()">Navigate to p1p1</button>
        <button onclick="navigateCurrent()">Navigate to Current</button>
    </div>
    
    <div class="section">
        <h2>Pack Display</h2>
        <div id="pack-display"></div>
    </div>
    
    <div class="section">
        <h2>Debug Log</h2>
        <div id="debug-log"></div>
    </div>

    <script>
        // Simulated draft state
        let engineState = {
            currentRound: 1,
            currentPick: 1,
            humanDeck: [],
            packs: {
                1: {
                    0: { 
                        id: 'pack_0',
                        cards: [
                            { id: 'card_1', name: 'Card 1' },
                            { id: 'card_2', name: 'Card 2' },
                            { id: 'card_3', name: 'Card 3' },
                            { id: 'card_4', name: 'Card 4' },
                            { id: 'card_5', name: 'Card 5' }
                        ]
                    }
                }
            },
            actionHistory: []
        };
        
        let viewingPosition = { round: 1, pick: 1 };
        
        function log(message) {
            const logDiv = document.getElementById('debug-log');
            logDiv.innerHTML = `<div>${new Date().toLocaleTimeString()}: ${message}</div>` + logDiv.innerHTML;
        }
        
        function updateDisplay() {
            // Update current state display
            document.getElementById('current-state').innerHTML = `
                <strong>Engine Position:</strong> P${engineState.currentRound}P${engineState.currentPick}<br>
                <strong>Viewing Position:</strong> P${viewingPosition.round}P${viewingPosition.pick}<br>
                <strong>Human Deck Size:</strong> ${engineState.humanDeck.length}<br>
                <strong>Is At Engine Position:</strong> ${isAtEnginePosition()}
            `;
            
            // Get pack to display
            const pack = getCurrentPack();
            let packHtml = '';
            
            if (pack) {
                packHtml = `<strong>Pack ID:</strong> ${pack.id}<br><strong>Cards:</strong><br>`;
                pack.cards.forEach(card => {
                    const isPicked = engineState.humanDeck.includes(card.id);
                    packHtml += `<div class="card ${isPicked ? 'picked' : ''}">${card.name}</div>`;
                });
            } else {
                packHtml = 'No pack available';
            }
            
            document.getElementById('pack-display').innerHTML = packHtml;
        }
        
        function isAtEnginePosition() {
            return viewingPosition.round === engineState.currentRound && 
                   viewingPosition.pick === engineState.currentPick;
        }
        
        function getCurrentPack() {
            log(`Getting pack for viewing position P${viewingPosition.round}P${viewingPosition.pick}`);
            
            if (isAtEnginePosition()) {
                log('Using current engine state');
                return engineState.packs[viewingPosition.round][0];
            } else {
                log('Using replay state');
                // Simulate replay
                const replayedState = replayToPosition(viewingPosition.round, viewingPosition.pick);
                return replayedState.packs[viewingPosition.round][0];
            }
        }
        
        function replayToPosition(round, pick) {
            log(`Replaying to P${round}P${pick}`);
            
            // Create a copy of initial state
            const replayed = {
                currentRound: 1,
                currentPick: 1,
                humanDeck: [],
                packs: {
                    1: {
                        0: { 
                            id: 'pack_0',
                            cards: [
                                { id: 'card_1', name: 'Card 1' },
                                { id: 'card_2', name: 'Card 2' },
                                { id: 'card_3', name: 'Card 3' },
                                { id: 'card_4', name: 'Card 4' },
                                { id: 'card_5', name: 'Card 5' }
                            ]
                        }
                    }
                }
            };
            
            // Apply actions up to target position
            for (const action of engineState.actionHistory) {
                if (replayed.currentRound === round && replayed.currentPick === pick) {
                    break;
                }
                
                if (action.type === 'PICK') {
                    // Apply pick
                    replayed.humanDeck.push(action.cardId);
                    replayed.packs[1][0].cards = replayed.packs[1][0].cards.filter(c => c.id !== action.cardId);
                    replayed.currentPick++;
                }
            }
            
            log(`Replay complete. Deck size: ${replayed.humanDeck.length}`);
            return replayed;
        }
        
        function pickCard() {
            if (!isAtEnginePosition()) {
                alert('Can only pick at current position!');
                return;
            }
            
            const pack = engineState.packs[1][0];
            if (pack.cards.length === 0) {
                alert('No cards to pick!');
                return;
            }
            
            const cardToPick = pack.cards[0];
            log(`Picking ${cardToPick.name}`);
            
            // Add to deck
            engineState.humanDeck.push(cardToPick.id);
            
            // Remove from pack
            pack.cards = pack.cards.filter(c => c.id !== cardToPick.id);
            
            // Record action
            engineState.actionHistory.push({
                type: 'PICK',
                cardId: cardToPick.id,
                position: { round: engineState.currentRound, pick: engineState.currentPick }
            });
            
            // Advance position
            engineState.currentPick++;
            viewingPosition = { round: engineState.currentRound, pick: engineState.currentPick };
            
            updateDisplay();
        }
        
        function navigateBack() {
            log('Navigating to P1P1');
            viewingPosition = { round: 1, pick: 1 };
            updateDisplay();
        }
        
        function navigateCurrent() {
            log(`Navigating to current position P${engineState.currentRound}P${engineState.currentPick}`);
            viewingPosition = { round: engineState.currentRound, pick: engineState.currentPick };
            updateDisplay();
        }
        
        // Initial display
        updateDisplay();
    </script>
</body>
</html>